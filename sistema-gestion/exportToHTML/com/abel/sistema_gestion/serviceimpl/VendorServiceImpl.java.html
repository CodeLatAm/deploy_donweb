<html>
<head>
<title>VendorServiceImpl.java</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
VendorServiceImpl.java</font>
</center></td></tr></table>
<pre><span class="s0">package </span><span class="s1">com</span><span class="s2">.</span><span class="s1">abel</span><span class="s2">.</span><span class="s1">sistema_gestion</span><span class="s2">.</span><span class="s1">serviceimpl</span><span class="s2">;</span>

<span class="s0">import </span><span class="s1">com</span><span class="s2">.</span><span class="s1">abel</span><span class="s2">.</span><span class="s1">sistema_gestion</span><span class="s2">.</span><span class="s1">dto</span><span class="s2">.</span><span class="s1">MessageResponse</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">com</span><span class="s2">.</span><span class="s1">abel</span><span class="s2">.</span><span class="s1">sistema_gestion</span><span class="s2">.</span><span class="s1">dto</span><span class="s2">.</span><span class="s1">vendor</span><span class="s2">.</span><span class="s1">VendorProfileResponse</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">com</span><span class="s2">.</span><span class="s1">abel</span><span class="s2">.</span><span class="s1">sistema_gestion</span><span class="s2">.</span><span class="s1">dto</span><span class="s2">.</span><span class="s1">vendor</span><span class="s2">.</span><span class="s1">VendorRequest</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">com</span><span class="s2">.</span><span class="s1">abel</span><span class="s2">.</span><span class="s1">sistema_gestion</span><span class="s2">.</span><span class="s1">dto</span><span class="s2">.</span><span class="s1">vendor</span><span class="s2">.</span><span class="s1">VendorResponse</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">com</span><span class="s2">.</span><span class="s1">abel</span><span class="s2">.</span><span class="s1">sistema_gestion</span><span class="s2">.</span><span class="s1">dto</span><span class="s2">.</span><span class="s1">vendor</span><span class="s2">.</span><span class="s1">VendorUpdateRequest</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">com</span><span class="s2">.</span><span class="s1">abel</span><span class="s2">.</span><span class="s1">sistema_gestion</span><span class="s2">.</span><span class="s1">entity</span><span class="s2">.*;</span>
<span class="s0">import </span><span class="s1">com</span><span class="s2">.</span><span class="s1">abel</span><span class="s2">.</span><span class="s1">sistema_gestion</span><span class="s2">.</span><span class="s1">enums</span><span class="s2">.</span><span class="s1">SaleStatus</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">com</span><span class="s2">.</span><span class="s1">abel</span><span class="s2">.</span><span class="s1">sistema_gestion</span><span class="s2">.</span><span class="s1">enums</span><span class="s2">.</span><span class="s1">UserStatus</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">com</span><span class="s2">.</span><span class="s1">abel</span><span class="s2">.</span><span class="s1">sistema_gestion</span><span class="s2">.</span><span class="s1">enums</span><span class="s2">.</span><span class="s1">VendorStatus</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">com</span><span class="s2">.</span><span class="s1">abel</span><span class="s2">.</span><span class="s1">sistema_gestion</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">.</span><span class="s1">VendorAlreadyExistsException</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">com</span><span class="s2">.</span><span class="s1">abel</span><span class="s2">.</span><span class="s1">sistema_gestion</span><span class="s2">.</span><span class="s1">exception</span><span class="s2">.</span><span class="s1">VendorNotFoundException</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">com</span><span class="s2">.</span><span class="s1">abel</span><span class="s2">.</span><span class="s1">sistema_gestion</span><span class="s2">.</span><span class="s1">mapper</span><span class="s2">.</span><span class="s1">VendorMapper</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">com</span><span class="s2">.</span><span class="s1">abel</span><span class="s2">.</span><span class="s1">sistema_gestion</span><span class="s2">.</span><span class="s1">repository</span><span class="s2">.</span><span class="s1">ClientRepository</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">com</span><span class="s2">.</span><span class="s1">abel</span><span class="s2">.</span><span class="s1">sistema_gestion</span><span class="s2">.</span><span class="s1">repository</span><span class="s2">.</span><span class="s1">VendorRepository</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">com</span><span class="s2">.</span><span class="s1">abel</span><span class="s2">.</span><span class="s1">sistema_gestion</span><span class="s2">.</span><span class="s1">serviceimpl</span><span class="s2">.</span><span class="s1">service</span><span class="s2">.</span><span class="s1">UserService</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">com</span><span class="s2">.</span><span class="s1">abel</span><span class="s2">.</span><span class="s1">sistema_gestion</span><span class="s2">.</span><span class="s1">serviceimpl</span><span class="s2">.</span><span class="s1">service</span><span class="s2">.</span><span class="s1">VendorService</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">com</span><span class="s2">.</span><span class="s1">abel</span><span class="s2">.</span><span class="s1">sistema_gestion</span><span class="s2">.</span><span class="s1">serviceimpl</span><span class="s2">.</span><span class="s1">service</span><span class="s2">.</span><span class="s1">VendorStatusHistoryService</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">com</span><span class="s2">.</span><span class="s1">abel</span><span class="s2">.</span><span class="s1">sistema_gestion</span><span class="s2">.</span><span class="s1">specification</span><span class="s2">.</span><span class="s1">VendorSpecification</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">org</span><span class="s2">.</span><span class="s1">springframework</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">domain</span><span class="s2">.</span><span class="s1">Page</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">org</span><span class="s2">.</span><span class="s1">springframework</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">domain</span><span class="s2">.</span><span class="s1">Pageable</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">org</span><span class="s2">.</span><span class="s1">springframework</span><span class="s2">.</span><span class="s1">data</span><span class="s2">.</span><span class="s1">jpa</span><span class="s2">.</span><span class="s1">domain</span><span class="s2">.</span><span class="s1">Specification</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">org</span><span class="s2">.</span><span class="s1">springframework</span><span class="s2">.</span><span class="s1">http</span><span class="s2">.</span><span class="s1">HttpStatus</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">org</span><span class="s2">.</span><span class="s1">springframework</span><span class="s2">.</span><span class="s1">stereotype</span><span class="s2">.</span><span class="s1">Service</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">org</span><span class="s2">.</span><span class="s1">springframework</span><span class="s2">.</span><span class="s1">transaction</span><span class="s2">.</span><span class="s1">annotation</span><span class="s2">.</span><span class="s1">Transactional</span><span class="s2">;</span>

<span class="s0">import </span><span class="s1">java</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">List</span><span class="s2">;</span>
<span class="s0">import </span><span class="s1">java</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">Optional</span><span class="s2">;</span>

<span class="s1">@Service</span>
<span class="s0">public class </span><span class="s1">VendorServiceImpl </span><span class="s0">implements </span><span class="s1">VendorService </span><span class="s2">{</span>

    <span class="s0">private final </span><span class="s1">VendorRepository vendorRepository</span><span class="s2">;</span>
    
    <span class="s0">private final </span><span class="s1">VendorMapper vendorMapper</span><span class="s2">;</span>

    <span class="s0">private final </span><span class="s1">UserService userService</span><span class="s2">;</span>

    <span class="s0">private final </span><span class="s1">VendorStatusHistoryService statusHistoryService</span><span class="s2">;</span>

   <span class="s0">private final </span><span class="s1">ClientRepository clientRepository</span><span class="s2">;</span>

    <span class="s0">public </span><span class="s1">VendorServiceImpl</span><span class="s2">(</span><span class="s1">VendorRepository vendorRepository</span><span class="s2">, </span><span class="s1">VendorMapper vendorMapper</span><span class="s2">, </span><span class="s1">VendorStatusHistoryService statusHistoryService</span><span class="s2">,</span>
                             <span class="s1">UserService userService</span><span class="s2">, </span><span class="s1">ClientRepository clientRepository</span><span class="s2">) {</span>
        <span class="s0">this</span><span class="s2">.</span><span class="s1">vendorRepository </span><span class="s2">= </span><span class="s1">vendorRepository</span><span class="s2">;</span>
        <span class="s0">this</span><span class="s2">.</span><span class="s1">vendorMapper </span><span class="s2">= </span><span class="s1">vendorMapper</span><span class="s2">;</span>
        <span class="s0">this</span><span class="s2">.</span><span class="s1">statusHistoryService </span><span class="s2">= </span><span class="s1">statusHistoryService</span><span class="s2">;</span>
        <span class="s0">this</span><span class="s2">.</span><span class="s1">userService </span><span class="s2">= </span><span class="s1">userService</span><span class="s2">;</span>
        <span class="s0">this</span><span class="s2">.</span><span class="s1">clientRepository </span><span class="s2">= </span><span class="s1">clientRepository</span><span class="s2">;</span>

    <span class="s2">}</span>

    <span class="s1">@Transactional</span>
    <span class="s1">@Override</span>
    <span class="s0">public </span><span class="s1">MessageResponse createVendor</span><span class="s2">(</span><span class="s1">VendorRequest request</span><span class="s2">) {</span>
        <span class="s3">//TODO modificar la app permite unico email por vendedor para todos los users</span>
        <span class="s0">if</span><span class="s2">(</span><span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">existsByEmail</span><span class="s2">(</span><span class="s1">request</span><span class="s2">.</span><span class="s1">getEmail</span><span class="s2">())){</span>
            <span class="s0">throw new </span><span class="s1">VendorAlreadyExistsException</span><span class="s2">(</span><span class="s4">&quot;El vendedor ya existe&quot;</span><span class="s2">);</span>
        <span class="s2">}</span>
        <span class="s0">if</span><span class="s2">(</span><span class="s1">request</span><span class="s2">.</span><span class="s1">getPlan</span><span class="s2">().</span><span class="s1">equals</span><span class="s2">(</span><span class="s4">&quot;FREE&quot;</span><span class="s2">) &amp;&amp; </span><span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">countByUserIdAndPlan</span><span class="s2">(</span><span class="s1">request</span><span class="s2">.</span><span class="s1">getUserId</span><span class="s2">(),</span><span class="s1">request</span><span class="s2">.</span><span class="s1">getPlan</span><span class="s2">()) &gt;= </span><span class="s5">1</span><span class="s2">){</span>
            <span class="s0">throw new </span><span class="s1">VendorNotFoundException</span><span class="s2">(</span><span class="s4">&quot;Ya tienes un vendedor en el plan FREE. Pasa a Premium para crear más.&quot;</span><span class="s2">);</span>
        <span class="s2">}</span>
        <span class="s1">User user </span><span class="s2">=  </span><span class="s1">userService</span><span class="s2">.</span><span class="s1">getUserByUserId</span><span class="s2">(</span><span class="s1">request</span><span class="s2">.</span><span class="s1">getUserId</span><span class="s2">());</span>
        <span class="s1">Vendor vendor </span><span class="s2">= </span><span class="s1">vendorMapper</span><span class="s2">.</span><span class="s1">mapToVendorRequest</span><span class="s2">(</span><span class="s1">request</span><span class="s2">);</span>
        <span class="s1">vendor</span><span class="s2">.</span><span class="s1">setUserStatus</span><span class="s2">(</span><span class="s1">user</span><span class="s2">.</span><span class="s1">getUserStatus</span><span class="s2">());</span>
        <span class="s1">vendor</span><span class="s2">.</span><span class="s1">setPlan</span><span class="s2">(</span><span class="s1">user</span><span class="s2">.</span><span class="s1">getUserStatus</span><span class="s2">().</span><span class="s1">name</span><span class="s2">());</span>
        <span class="s1">Cart cart </span><span class="s2">= </span><span class="s0">new </span><span class="s1">Cart</span><span class="s2">();</span>
        <span class="s1">vendor</span><span class="s2">.</span><span class="s1">setCart</span><span class="s2">(</span><span class="s1">cart</span><span class="s2">);</span>
        <span class="s1">cart</span><span class="s2">.</span><span class="s1">setVendor</span><span class="s2">(</span><span class="s1">vendor</span><span class="s2">);</span>
        <span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s1">vendor</span><span class="s2">);</span>
        <span class="s0">return </span><span class="s1">MessageResponse</span><span class="s2">.</span><span class="s1">builder</span><span class="s2">()</span>
                <span class="s2">.</span><span class="s1">httpStatus</span><span class="s2">(</span><span class="s1">HttpStatus</span><span class="s2">.</span><span class="s1">CREATED</span><span class="s2">)</span>
                <span class="s2">.</span><span class="s1">message</span><span class="s2">(</span><span class="s4">&quot;Vendedor creado&quot;</span><span class="s2">)</span>
                <span class="s2">.</span><span class="s1">build</span><span class="s2">();</span>
    <span class="s2">}</span>

    <span class="s1">@Override</span>
    <span class="s0">public </span><span class="s1">List</span><span class="s2">&lt;</span><span class="s1">VendorResponse</span><span class="s2">&gt; </span><span class="s1">getAllVendorsByUserId</span><span class="s2">(</span><span class="s1">Integer userId</span><span class="s2">) {</span>
        <span class="s0">if</span><span class="s2">(</span><span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">count</span><span class="s2">() &gt; </span><span class="s5">0 </span><span class="s2">&amp;&amp; !</span><span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">existsByUserId</span><span class="s2">(</span><span class="s1">userId</span><span class="s2">)){</span>
            <span class="s0">throw new </span><span class="s1">VendorNotFoundException</span><span class="s2">(</span><span class="s4">&quot;El User con userId: &quot; </span><span class="s2">+ </span><span class="s1">userId </span><span class="s2">+ </span><span class="s4">&quot; no esta registrado&quot;</span><span class="s2">);</span>
        <span class="s2">}</span>

        <span class="s1">List</span><span class="s2">&lt;</span><span class="s1">Vendor</span><span class="s2">&gt; </span><span class="s1">vendors </span><span class="s2">= </span><span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">findByUserId</span><span class="s2">(</span><span class="s1">userId</span><span class="s2">);</span>
        <span class="s3">//List&lt;Vendor&gt; vendorsActive = vendorRepository.findAllByUserIdAndActivoTrue(userId);</span>
        <span class="s0">return </span><span class="s1">vendorMapper</span><span class="s2">.</span><span class="s1">mapToVendorResponseList</span><span class="s2">(</span><span class="s1">vendors</span><span class="s2">);</span>

    <span class="s2">}</span>

    <span class="s1">@Override</span>
    <span class="s0">public </span><span class="s1">Vendor findById</span><span class="s2">(</span><span class="s1">Integer vendorId</span><span class="s2">) {</span>
        <span class="s0">return </span><span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">findById</span><span class="s2">(</span><span class="s1">vendorId</span><span class="s2">).</span><span class="s1">orElseThrow</span><span class="s2">(() </span><span class="s1">-&gt; </span><span class="s0">new </span><span class="s1">VendorNotFoundException</span><span class="s2">(</span><span class="s4">&quot;El vendedor no existe&quot;</span><span class="s2">));</span>
    <span class="s2">}</span>

    <span class="s1">@Override</span>
    <span class="s0">public </span><span class="s1">MessageResponse vendorUpdate</span><span class="s2">(</span><span class="s1">VendorUpdateRequest request</span><span class="s2">) {</span>
        <span class="s1">Optional</span><span class="s2">&lt;</span><span class="s1">Vendor</span><span class="s2">&gt; </span><span class="s1">vendor </span><span class="s2">= </span><span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">findByUserIdAndId</span><span class="s2">(</span><span class="s1">request</span><span class="s2">.</span><span class="s1">getUserId</span><span class="s2">(), </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getId</span><span class="s2">());</span>
        <span class="s0">if</span><span class="s2">(</span><span class="s1">vendor</span><span class="s2">.</span><span class="s1">isEmpty</span><span class="s2">()){</span>
            <span class="s0">throw new </span><span class="s1">VendorNotFoundException</span><span class="s2">(</span><span class="s4">&quot;Vendedor no encontrado&quot;</span><span class="s2">);</span>
        <span class="s2">}</span>
        <span class="s1">vendorMapper</span><span class="s2">.</span><span class="s1">mapToVendorUpdate</span><span class="s2">(</span><span class="s1">vendor</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(), </span><span class="s1">request</span><span class="s2">);</span>
        <span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s1">vendor</span><span class="s2">.</span><span class="s1">get</span><span class="s2">());</span>
        <span class="s0">return new </span><span class="s1">MessageResponse</span><span class="s2">(</span><span class="s4">&quot;Vendedor actualizado&quot;</span><span class="s2">, </span><span class="s1">HttpStatus</span><span class="s2">.</span><span class="s1">OK</span><span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">@Transactional</span>
    <span class="s1">@Override</span>
    <span class="s0">public void </span><span class="s1">deletedVendor</span><span class="s2">(</span><span class="s1">Integer id</span><span class="s2">) {</span>
        <span class="s1">Vendor vendor </span><span class="s2">= </span><span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">findById</span><span class="s2">(</span><span class="s1">id</span><span class="s2">).</span><span class="s1">orElseThrow</span><span class="s2">(() </span><span class="s1">-&gt; </span><span class="s0">new </span><span class="s1">VendorNotFoundException</span><span class="s2">(</span><span class="s4">&quot;Vendedor not fount&quot;</span><span class="s2">));</span>
        <span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">delete</span><span class="s2">(</span><span class="s1">vendor</span><span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">@Override</span>
    <span class="s0">public </span><span class="s1">VendorResponse getAllVendorsByUserIdAndVendorId</span><span class="s2">(</span><span class="s1">Integer userId</span><span class="s2">, </span><span class="s1">Integer id</span><span class="s2">) {</span>
        <span class="s1">Vendor vendor </span><span class="s2">= </span><span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">findByUserIdAndId</span><span class="s2">(</span><span class="s1">userId</span><span class="s2">, </span><span class="s1">id</span><span class="s2">).</span><span class="s1">orElseThrow</span><span class="s2">(() </span><span class="s1">-&gt; </span><span class="s0">new </span><span class="s1">VendorNotFoundException</span><span class="s2">(</span><span class="s4">&quot;Vendedor not fount&quot;</span><span class="s2">));</span>
        <span class="s0">return </span><span class="s1">vendorMapper</span><span class="s2">.</span><span class="s1">mapToVendorResponse</span><span class="s2">(</span><span class="s1">vendor</span><span class="s2">);</span>

    <span class="s2">}</span>

    <span class="s1">@Transactional</span>
    <span class="s1">@Override</span>
    <span class="s0">public </span><span class="s1">MessageResponse modifySellerStatus</span><span class="s2">(</span><span class="s1">Integer id</span><span class="s2">, </span><span class="s1">Integer userId</span><span class="s2">, </span><span class="s1">String statusName</span><span class="s2">) {</span>
        <span class="s3">// Encuentra el vendor por ID y userId, o lanza una excepción si no se encuentra</span>
        <span class="s1">Vendor vendor </span><span class="s2">= </span><span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">findByIdAndUserId</span><span class="s2">(</span><span class="s1">id</span><span class="s2">, </span><span class="s1">userId</span><span class="s2">)</span>
                <span class="s2">.</span><span class="s1">orElseThrow</span><span class="s2">(() </span><span class="s1">-&gt; </span><span class="s0">new </span><span class="s1">VendorNotFoundException</span><span class="s2">(</span><span class="s4">&quot;Vendedor no encontrado&quot;</span><span class="s2">));</span>

        <span class="s0">switch </span><span class="s2">(</span><span class="s1">statusName</span><span class="s2">) {</span>
            <span class="s0">case </span><span class="s4">&quot;Inactivo&quot;</span><span class="s2">:</span>
                <span class="s1">vendor</span><span class="s2">.</span><span class="s1">setVendorStatus</span><span class="s2">(</span><span class="s1">VendorStatus</span><span class="s2">.</span><span class="s1">INACTIVE</span><span class="s2">);</span>
                <span class="s0">break</span><span class="s2">;</span>
            <span class="s0">case </span><span class="s4">&quot;Desactivado&quot;</span><span class="s2">:</span>
                <span class="s1">vendor</span><span class="s2">.</span><span class="s1">setVendorStatus</span><span class="s2">(</span><span class="s1">VendorStatus</span><span class="s2">.</span><span class="s1">SUSPENDED</span><span class="s2">);</span>
                <span class="s0">break</span><span class="s2">;</span>
            <span class="s0">case </span><span class="s4">&quot;Activado&quot;</span><span class="s2">:</span>
                <span class="s1">vendor</span><span class="s2">.</span><span class="s1">setVendorStatus</span><span class="s2">(</span><span class="s1">VendorStatus</span><span class="s2">.</span><span class="s1">ACTIVE</span><span class="s2">);</span>
                <span class="s0">break</span><span class="s2">;</span>
            <span class="s0">default</span><span class="s2">:</span>
                <span class="s0">throw new </span><span class="s1">IllegalArgumentException</span><span class="s2">(</span><span class="s4">&quot;Estado inválido: &quot; </span><span class="s2">+ </span><span class="s1">statusName</span><span class="s2">);</span>
        <span class="s2">}</span>

        <span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s1">vendor</span><span class="s2">);</span>
        <span class="s1">System</span><span class="s2">.</span><span class="s1">out</span><span class="s2">.</span><span class="s1">println</span><span class="s2">(</span><span class="s4">&quot;Vendor guardado con nuevo estado: &quot; </span><span class="s2">+ </span><span class="s1">vendor</span><span class="s2">.</span><span class="s1">getVendorStatus</span><span class="s2">());</span>

        <span class="s3">// Este método es crucial, si falla, la transacción no se completará</span>
        <span class="s1">statusHistoryService</span><span class="s2">.</span><span class="s1">createVendorStatusHistory</span><span class="s2">(</span><span class="s1">vendor</span><span class="s2">);</span>
        <span class="s1">System</span><span class="s2">.</span><span class="s1">out</span><span class="s2">.</span><span class="s1">println</span><span class="s2">(</span><span class="s4">&quot;Historial de estado creado&quot;</span><span class="s2">);</span>

        <span class="s0">return new </span><span class="s1">MessageResponse</span><span class="s2">(</span><span class="s4">&quot;Estado actualizado&quot;</span><span class="s2">, </span><span class="s1">HttpStatus</span><span class="s2">.</span><span class="s1">OK</span><span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">@Override</span>
    <span class="s0">public </span><span class="s1">Integer quantityToBeShipped</span><span class="s2">(</span><span class="s1">Integer vendorId</span><span class="s2">) {</span>
        <span class="s3">// Buscar al vendedor por ID</span>
        <span class="s1">Vendor vendor </span><span class="s2">= </span><span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">findById</span><span class="s2">(</span><span class="s1">vendorId</span><span class="s2">)</span>
                <span class="s2">.</span><span class="s1">orElseThrow</span><span class="s2">(() </span><span class="s1">-&gt; </span><span class="s0">new </span><span class="s1">VendorNotFoundException</span><span class="s2">(</span><span class="s4">&quot;Vendedor no encontrado con id: &quot; </span><span class="s2">+ </span><span class="s1">vendorId</span><span class="s2">));</span>

        <span class="s3">// Contar la cantidad de ventas con estado &quot;PENDIENTE&quot;</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s0">int</span><span class="s2">) </span><span class="s1">vendor</span><span class="s2">.</span><span class="s1">getVendorSales</span><span class="s2">().</span><span class="s1">stream</span><span class="s2">()</span>
                <span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">v -&gt; v</span><span class="s2">.</span><span class="s1">getSaleStatus</span><span class="s2">() == </span><span class="s1">SaleStatus</span><span class="s2">.</span><span class="s1">PENDIENTE</span><span class="s2">)  </span><span class="s3">// Filtrar las ventas con estatus &quot;PENDIENTE&quot;</span>
                <span class="s2">.</span><span class="s1">count</span><span class="s2">();</span>
    <span class="s2">}</span>

    <span class="s1">@Override</span>
    <span class="s0">public </span><span class="s1">Integer quantityToBeShippedDispatched</span><span class="s2">(</span><span class="s1">Integer vendorId</span><span class="s2">) {</span>
        <span class="s3">// Buscar al vendedor por ID</span>
        <span class="s1">Vendor vendor </span><span class="s2">= </span><span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">findById</span><span class="s2">(</span><span class="s1">vendorId</span><span class="s2">)</span>
                <span class="s2">.</span><span class="s1">orElseThrow</span><span class="s2">(() </span><span class="s1">-&gt; </span><span class="s0">new </span><span class="s1">VendorNotFoundException</span><span class="s2">(</span><span class="s4">&quot;Vendedor no encontrado con id: &quot; </span><span class="s2">+ </span><span class="s1">vendorId</span><span class="s2">));</span>

        <span class="s3">// Contar la cantidad de ventas con estado &quot;PENDIENTE&quot;</span>
        <span class="s0">return </span><span class="s2">(</span><span class="s0">int</span><span class="s2">) </span><span class="s1">vendor</span><span class="s2">.</span><span class="s1">getVendorSales</span><span class="s2">().</span><span class="s1">stream</span><span class="s2">()</span>
                <span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">v -&gt; v</span><span class="s2">.</span><span class="s1">getSaleStatus</span><span class="s2">() == </span><span class="s1">SaleStatus</span><span class="s2">.</span><span class="s1">DESPACHADO</span><span class="s2">)  </span><span class="s3">// Filtrar las ventas con estatus &quot;Despachado&quot;</span>
                <span class="s2">.</span><span class="s1">count</span><span class="s2">();</span>
    <span class="s2">}</span>

    <span class="s1">@Override</span>
    <span class="s0">public </span><span class="s1">Integer getCountVendorsByUserId</span><span class="s2">(</span><span class="s1">Integer userId</span><span class="s2">) {</span>

        <span class="s0">return </span><span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">getCountVendorsByUserId</span><span class="s2">(</span><span class="s1">userId</span><span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">@Override</span>
    <span class="s0">public </span><span class="s1">Integer countDistinctClientsByUserId</span><span class="s2">(</span><span class="s1">Integer userId</span><span class="s2">) {</span>
        <span class="s0">if</span><span class="s2">(!</span><span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">existsById</span><span class="s2">(</span><span class="s1">userId</span><span class="s2">)){</span>
            <span class="s3">//throw new VendorNotFoundException(&quot;El User con userId: &quot; + userId + &quot; no esta registrado&quot;);</span>
            <span class="s0">return </span><span class="s5">0</span><span class="s2">;</span>
        <span class="s2">}</span>
        <span class="s0">return </span><span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">countDistinctClientsByUserId</span><span class="s2">(</span><span class="s1">userId</span><span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">@Override</span>
    <span class="s0">public </span><span class="s1">VendorProfileResponse getInfoVendor</span><span class="s2">(</span><span class="s1">Integer vendorId</span><span class="s2">) {</span>
        <span class="s1">Vendor vendor </span><span class="s2">= </span><span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">findById</span><span class="s2">(</span><span class="s1">vendorId</span><span class="s2">).</span><span class="s1">orElseThrow</span><span class="s2">(</span>
                <span class="s2">() </span><span class="s1">-&gt; </span><span class="s2">{</span>
                    <span class="s0">return new </span><span class="s1">VendorNotFoundException</span><span class="s2">(</span><span class="s4">&quot;Vendedor no encontrado con id: &quot; </span><span class="s2">+ </span><span class="s1">vendorId</span><span class="s2">);</span>
                <span class="s2">});</span>
        <span class="s0">return </span><span class="s1">vendorMapper</span><span class="s2">.</span><span class="s1">mapToVendorProfileResponse</span><span class="s2">(</span><span class="s1">vendor</span><span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">@Override</span>
    <span class="s0">public </span><span class="s1">Page</span><span class="s2">&lt;</span><span class="s1">VendorResponse</span><span class="s2">&gt; </span><span class="s1">getAllVendorsByUserIdPage</span><span class="s2">(</span><span class="s1">Integer userId</span><span class="s2">, </span><span class="s1">Pageable pageable</span><span class="s2">, </span><span class="s1">String filter</span><span class="s2">) {</span>
        <span class="s1">User user </span><span class="s2">= </span><span class="s1">userService</span><span class="s2">.</span><span class="s1">getUserByUserId</span><span class="s2">(</span><span class="s1">userId</span><span class="s2">);</span>
        <span class="s1">Specification</span><span class="s2">&lt;</span><span class="s1">Vendor</span><span class="s2">&gt; </span><span class="s1">specification </span><span class="s2">= </span><span class="s1">Specification</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">VendorSpecification</span><span class="s2">.</span><span class="s1">byUserIdAndActivo</span><span class="s2">(</span><span class="s1">userId</span><span class="s2">))</span>
                <span class="s2">.</span><span class="s1">and</span><span class="s2">(</span><span class="s1">VendorSpecification</span><span class="s2">.</span><span class="s1">filterByAttributes</span><span class="s2">(</span><span class="s1">filter</span><span class="s2">));</span>

        <span class="s0">if</span><span class="s2">(</span><span class="s1">filter </span><span class="s2">!= </span><span class="s0">null </span><span class="s2">&amp;&amp; !</span><span class="s1">filter</span><span class="s2">.</span><span class="s1">isEmpty</span><span class="s2">()) {</span>
            <span class="s1">specification </span><span class="s2">= </span><span class="s1">specification</span><span class="s2">.</span><span class="s1">and</span><span class="s2">(</span><span class="s1">VendorSpecification</span><span class="s2">.</span><span class="s1">filterByAttributes</span><span class="s2">(</span><span class="s1">filter</span><span class="s2">));</span>
        <span class="s2">}</span>
        <span class="s1">Page</span><span class="s2">&lt;</span><span class="s1">Vendor</span><span class="s2">&gt; </span><span class="s1">vendors </span><span class="s2">= </span><span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">findAll</span><span class="s2">(</span><span class="s1">specification</span><span class="s2">, </span><span class="s1">pageable</span><span class="s2">);</span>

        <span class="s1">System</span><span class="s2">.</span><span class="s1">out</span><span class="s2">.</span><span class="s1">print</span><span class="s2">(</span><span class="s4">&quot;Servicio getAllVendorsByUserIdPage &quot;</span><span class="s2">);</span>
        <span class="s0">return </span><span class="s1">vendorMapper</span><span class="s2">.</span><span class="s1">mapToVendorPageResponse</span><span class="s2">(</span><span class="s1">vendors</span><span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s1">@Override</span>
    <span class="s0">public void </span><span class="s1">updateUserStatusVendors</span><span class="s2">(</span><span class="s1">Integer userId</span><span class="s2">) {</span>
        <span class="s1">List</span><span class="s2">&lt;</span><span class="s1">Vendor</span><span class="s2">&gt; </span><span class="s1">vendors </span><span class="s2">= </span><span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">findAllByUserId</span><span class="s2">(</span><span class="s1">userId</span><span class="s2">);</span>
        <span class="s3">//vendor.setUserStatus(UserStatus.PREMIUM)</span>
        <span class="s1">vendors</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">(</span><span class="s0">this</span><span class="s1">::actualizarEstados</span><span class="s2">);</span>
        <span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">saveAll</span><span class="s2">(</span><span class="s1">vendors</span><span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s0">private void </span><span class="s1">actualizarEstados</span><span class="s2">(</span><span class="s1">Vendor vendor</span><span class="s2">) {</span>
        <span class="s1">vendor</span><span class="s2">.</span><span class="s1">setPlan</span><span class="s2">(</span><span class="s4">&quot;PREMIUM&quot;</span><span class="s2">);</span>
        <span class="s1">vendor</span><span class="s2">.</span><span class="s1">setUserStatus</span><span class="s2">(</span><span class="s1">UserStatus</span><span class="s2">.</span><span class="s1">PREMIUM</span><span class="s2">);</span>
        <span class="s1">vendor</span><span class="s2">.</span><span class="s1">setActivo</span><span class="s2">(</span><span class="s0">true</span><span class="s2">);</span>
        <span class="s3">//TODO buscar los clientes dados de activo false y activarlos nuevamente si hay</span>
        <span class="s3">// Activar solo los clientes inactivos</span>
        <span class="s1">vendor</span><span class="s2">.</span><span class="s1">getClientList</span><span class="s2">().</span><span class="s1">stream</span><span class="s2">()</span>
                <span class="s2">.</span><span class="s1">filter</span><span class="s2">(</span><span class="s1">client -&gt; </span><span class="s2">!</span><span class="s1">client</span><span class="s2">.</span><span class="s1">isActivo</span><span class="s2">())</span>
                <span class="s2">.</span><span class="s1">forEach</span><span class="s2">(</span><span class="s1">client -&gt; client</span><span class="s2">.</span><span class="s1">setActivo</span><span class="s2">(</span><span class="s0">true</span><span class="s2">));</span>
    <span class="s2">}</span>

<span class="s3">/* 
    @Override 
    public void updateUserStatusFreeVendors(Integer userId) { 
        List&lt;Vendor&gt; vendors = vendorRepository.findAllByUserId(userId); 
        vendors.forEach(vendor -&gt; vendor.setUserStatus(UserStatus.FREE)); 
        vendorRepository.saveAll(vendors); 
    } 
*/</span>
    <span class="s1">@Override</span>
    <span class="s0">public void </span><span class="s1">updateUserStatusFreeVendors</span><span class="s2">(</span><span class="s1">Integer userId</span><span class="s2">) {</span>
    <span class="s1">List</span><span class="s2">&lt;</span><span class="s1">Vendor</span><span class="s2">&gt; </span><span class="s1">vendors </span><span class="s2">= </span><span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">findAllByUserId</span><span class="s2">(</span><span class="s1">userId</span><span class="s2">);</span>

    <span class="s1">vendors</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">(</span><span class="s1">vendor -&gt; </span><span class="s2">{</span>
        <span class="s1">vendor</span><span class="s2">.</span><span class="s1">setUserStatus</span><span class="s2">(</span><span class="s1">UserStatus</span><span class="s2">.</span><span class="s1">FREE</span><span class="s2">);</span>
        <span class="s1">vendor</span><span class="s2">.</span><span class="s1">setPlan</span><span class="s2">(</span><span class="s4">&quot;FREE&quot;</span><span class="s2">);</span>
    <span class="s2">});</span>

    <span class="s3">// Guardar los cambios en los vendedores</span>
    <span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">saveAll</span><span class="s2">(</span><span class="s1">vendors</span><span class="s2">);</span>

    <span class="s3">// Aplicar las limitaciones de vendedores y clientes</span>
    <span class="s1">vendors</span><span class="s2">.</span><span class="s1">forEach</span><span class="s2">(</span><span class="s0">this</span><span class="s1">::limitarClientesYVendedores</span><span class="s2">);</span>
<span class="s2">}</span>

    <span class="s3">//TODO PROBAR</span>
    <span class="s1">@Transactional</span>
    <span class="s1">@Override</span>
    <span class="s0">public void </span><span class="s1">actualizarPlan</span><span class="s2">(</span><span class="s1">Integer vendedorId</span><span class="s2">, </span><span class="s1">String nuevoPlan</span><span class="s2">) {</span>
        <span class="s1">Vendor vendedor </span><span class="s2">= </span><span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">findById</span><span class="s2">(</span><span class="s1">vendedorId</span><span class="s2">)</span>
                <span class="s2">.</span><span class="s1">orElseThrow</span><span class="s2">(() </span><span class="s1">-&gt; </span><span class="s0">new </span><span class="s1">VendorNotFoundException</span><span class="s2">(</span><span class="s4">&quot;Vendedor no encontrado&quot;</span><span class="s2">));</span>

        <span class="s1">vendedor</span><span class="s2">.</span><span class="s1">setPlan</span><span class="s2">(</span><span class="s1">nuevoPlan</span><span class="s2">);</span>
        <span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">save</span><span class="s2">(</span><span class="s1">vendedor</span><span class="s2">);</span>

        <span class="s0">if </span><span class="s2">(</span><span class="s4">&quot;FREE&quot;</span><span class="s2">.</span><span class="s1">equals</span><span class="s2">(</span><span class="s1">nuevoPlan</span><span class="s2">)) {</span>
            <span class="s3">// Si el plan cambia a FREE, desactivar los clientes y vendedores adicionales</span>
            <span class="s0">this</span><span class="s2">.</span><span class="s1">limitarClientesYVendedores</span><span class="s2">(</span><span class="s1">vendedor</span><span class="s2">);</span>
        <span class="s2">}</span>
    <span class="s2">}</span>

    <span class="s0">private void </span><span class="s1">limitarClientesYVendedores</span><span class="s2">(</span><span class="s1">Vendor vendedor</span><span class="s2">) {</span>
        <span class="s3">// Limitar a un vendedor activo</span>
        <span class="s1">List</span><span class="s2">&lt;</span><span class="s1">Vendor</span><span class="s2">&gt; </span><span class="s1">vendedores </span><span class="s2">= </span><span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">findAllByUserIdAndActivoTrue</span><span class="s2">(</span><span class="s1">vendedor</span><span class="s2">.</span><span class="s1">getUserId</span><span class="s2">());</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">vendedores</span><span class="s2">.</span><span class="s1">size</span><span class="s2">() &gt; </span><span class="s5">1</span><span class="s2">) {</span>
            <span class="s1">vendedores</span><span class="s2">.</span><span class="s1">subList</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s1">vendedores</span><span class="s2">.</span><span class="s1">size</span><span class="s2">()).</span><span class="s1">forEach</span><span class="s2">(</span><span class="s1">v -&gt; v</span><span class="s2">.</span><span class="s1">setActivo</span><span class="s2">(</span><span class="s0">false</span><span class="s2">));</span>
        <span class="s2">}</span>

        <span class="s3">// Limitar a 5 clientes activos</span>
        <span class="s1">List</span><span class="s2">&lt;</span><span class="s1">Client</span><span class="s2">&gt; </span><span class="s1">clientes </span><span class="s2">= </span><span class="s1">clientRepository</span><span class="s2">.</span><span class="s1">findAllByVendorAndActivoTrue</span><span class="s2">(</span><span class="s1">vendedor</span><span class="s2">);</span>
        <span class="s0">if </span><span class="s2">(</span><span class="s1">clientes</span><span class="s2">.</span><span class="s1">size</span><span class="s2">() &gt; </span><span class="s5">2</span><span class="s2">) {</span>
            <span class="s1">clientes</span><span class="s2">.</span><span class="s1">subList</span><span class="s2">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">clientes</span><span class="s2">.</span><span class="s1">size</span><span class="s2">()).</span><span class="s1">forEach</span><span class="s2">(</span><span class="s1">c -&gt; c</span><span class="s2">.</span><span class="s1">setActivo</span><span class="s2">(</span><span class="s0">false</span><span class="s2">));</span>
        <span class="s2">}</span>

        <span class="s1">vendorRepository</span><span class="s2">.</span><span class="s1">saveAll</span><span class="s2">(</span><span class="s1">vendedores</span><span class="s2">);</span>
        <span class="s1">clientRepository</span><span class="s2">.</span><span class="s1">saveAll</span><span class="s2">(</span><span class="s1">clientes</span><span class="s2">);</span>
    <span class="s2">}</span>
<span class="s2">}</span>
</pre>
</body>
</html>